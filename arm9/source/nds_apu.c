#include "uxn.h"
#include "nds/apu.h"

/*
Copyright (c) 2021 Devine Lu Linvega
Copyright (c) 2021 Andrew Alderwick
Copyright (c) 2021 Adrian "asie" Siekierka

Permission to use, copy, modify, and distribute this software for any
purpose with or without fee is hereby granted, provided that the above
copyright notice and this permission notice appear in all copies.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
WITH REGARD TO THIS SOFTWARE.
*/

#define NOTE_PERIOD (SAMPLE_FREQUENCY * 0x4000 / 11025)
#define ADSR_STEP (SAMPLE_FREQUENCY / 0xf)

/* clang-format off */

static Uint32 advances[12] = {
	0x80000, 0x879c8, 0x8facd, 0x9837f, 0xa1451, 0xaadc1,
	0xb504f, 0xbfc88, 0xcb2ff, 0xd7450, 0xe411f, 0xf1a1c
};

static float detunes[256] = {
1.0000000000000000f, 1.0002256593050698f, 1.0004513695322617f, 
1.0006771306930664f, 1.0009029427989777f, 1.0011288058614922f, 
1.0013547198921082f, 1.0015806849023274f, 1.0018067009036538f, 
1.002032767907594f,  1.0022588859256572f, 1.0024850549693551f, 
1.0027112750502025f, 1.0029375461797159f, 1.0031638683694153f, 
1.0033902416308227f, 1.0036166659754628f, 1.0038431414148634f, 
1.004069667960554f,  1.0042962456240678f, 1.0045228744169397f, 
1.0047495543507072f, 1.004976285436911f,  1.0052030676870944f, 
1.0054299011128027f, 1.0056567857255843f, 1.0058837215369900f, 
1.006110708558573f,  1.0063377468018897f, 1.0065648362784985f, 
1.0067919769999607f, 1.0070191689778405f, 1.007246412223704f,  
1.0074737067491204f, 1.0077010525656616f, 1.0079284496849015f, 
1.0081558981184175f, 1.008383397877789f,  1.008610948974598f,  
1.0088385514204294f, 1.0090662052268706f, 1.0092939104055114f, 
1.0095216669679448f, 1.0097494749257656f, 1.009977334290572f,  
1.0102052450739643f, 1.0104332072875455f, 1.0106612209429215f, 
1.0108892860517005f, 1.0111174026254934f, 1.0113455706759138f, 
1.011573790214578f,  1.0118020612531047f, 1.0120303838031153f, 
1.0122587578762337f, 1.012487183484087f,  1.012715660638304f,  
1.0129441893505169f, 1.0131727696323602f, 1.0134014014954713f, 
1.0136300849514894f, 1.0138588200120575f, 1.0140876066888203f, 
1.0143164449934257f, 1.0145453349375237f, 1.0147742765327674f, 
1.0150032697908125f, 1.015232314723317f,  1.015461411341942f,  
1.0156905596583505f, 1.0159197596842091f, 1.0161490114311862f, 
1.016378314910953f,  1.0166076701351838f, 1.0168370771155553f, 
1.0170665358637463f, 1.0172960463914391f, 1.017525608710318f,  
1.0177552228320703f, 1.0179848887683858f, 1.0182146065309567f, 
1.0184443761314785f, 1.0186741975816487f, 1.0189040708931674f, 
1.019133996077738f,  1.0193639731470658f, 1.0195940021128593f, 
1.0198240829868295f, 1.0200542157806898f, 1.0202844005061564f, 
1.0205146371749483f, 1.0207449257987866f, 1.0209752663893958f, 
1.0212056589585028f, 1.0214361035178368f, 1.0216666000791297f, 
1.0218971486541166f, 1.0221277492545349f, 1.0223584018921241f, 
1.0225891065786274f, 1.02281986332579f,   1.0230506721453596f, 
1.023281533049087f,  1.0235124460487257f, 1.0237434111560313f, 
1.0239744283827625f, 1.0242054977406807f, 1.0244366192415495f, 
1.0246677928971357f, 1.0248990187192082f, 1.025130296719539f,  
1.0253616269099028f, 1.0255930093020766f, 1.0258244439078401f, 
1.026055930738976f,  1.0262874698072693f, 1.0265190611245079f, 
1.0267507047024822f, 1.0269824005529853f, 1.027214148687813f,  
1.0274459491187637f, 1.0276778018576387f, 1.0279097069162415f, 
1.0281416643063788f, 1.0283736740398595f, 1.0286057361284953f, 
1.028837850584101f,  1.0290700174184932f, 1.029302236643492f,  
1.0295345082709197f, 1.0297668323126017f, 1.029999208780365f,  
1.030231637686041f,  1.030464119041462f,  1.0306966528584645f, 
1.0309292391488862f, 1.0311618779245688f, 1.0313945691973556f, 
1.0316273129790936f, 1.0318601092816313f, 1.0320929581168212f, 
1.0323258594965172f, 1.0325588134325767f, 1.0327918199368598f, 
1.0330248790212284f, 1.033257990697548f,  1.0334911549776868f, 
1.033724371873515f,  1.0339576413969056f, 1.0341909635597348f, 
1.0344243383738811f, 1.034657765851226f,  1.034891246003653f,  
1.0351247788430489f, 1.0353583643813031f, 1.0355920026303078f, 
1.0358256936019572f, 1.0360594373081489f, 1.0362932337607829f, 
1.0365270829717617f, 1.0367609849529913f, 1.0369949397163791f, 
1.0372289472738365f, 1.0374630076372766f, 1.0376971208186156f, 
1.0379312868297725f, 1.0381655056826686f, 1.0383997773892284f, 
1.0386341019613787f, 1.0388684794110492f, 1.039102909750172f,  
1.0393373929906822f, 1.0395719291445176f, 1.0398065182236185f, 
1.0400411602399278f, 1.0402758552053915f, 1.0405106031319582f, 
1.0407454040315787f, 1.040980257916207f,  1.0412151647977996f, 
1.041450124688316f,  1.0416851375997183f, 1.0419202035439705f, 
1.0421553225330404f, 1.042390494578898f,  1.042625719693516f,  
1.0428609978888699f, 1.043096329176938f,  1.043331713569701f,  
1.0435671510791424f, 1.0438026417172486f, 1.0440381854960086f, 
1.0442737824274138f, 1.044509432523459f,  1.044745135796141f,  
1.04498089225746f,   1.045216701919418f,  1.0454525647940205f, 
1.0456884808932754f, 1.0459244502291931f, 1.0461604728137874f, 
1.046396548659074f,  1.046632677777072f,  1.0468688601798024f, 
1.0471050958792898f, 1.047341384887561f,  1.0475777272166455f, 
1.047814122878576f,  1.048050571885387f,  1.0482870742491166f, 
1.0485236299818055f, 1.0487602390954964f, 1.0489969016022356f, 
1.0492336175140715f, 1.0494703868430555f, 1.0497072096012419f, 
1.0499440858006872f, 1.0501810154534512f, 1.050417998571596f,  
1.0506550351671864f, 1.0508921252522903f, 1.0511292688389782f, 
1.051366465939323f,  1.0516037165654004f, 1.0518410207292894f, 
1.052078378443071f,  1.0523157897188296f, 1.0525532545686513f, 
1.0527907730046264f, 1.0530283450388465f, 1.0532659706834067f, 
1.053503649950405f,  1.053741382851941f,  1.0539791694001188f, 
1.0542170096070436f, 1.0544549034848243f, 1.0546928510455722f, 
1.0549308523014012f, 1.0551689072644284f, 1.0554070159467728f, 
1.0556451783605572f, 1.0558833945179062f, 1.056121664430948f,  
1.0563599881118126f, 1.0565983655726334f, 1.0568367968255465f, 
1.0570752818826903f, 1.0573138207562065f, 1.057552413458239f,  
1.0577910600009348f, 1.0580297603964437f, 1.058268514656918f,  
1.0585073227945128f, 1.0587461848213857f, 1.058985100749698f,  
1.0592240705916123f, 
};

/* clang-format on */

static Sint32
envelope(NdsApu *c, Uint32 age)
{
	if(!c->r) return 0x0888;
	if(age < c->a) return 0x0888 * age / c->a;
	if(age < c->d) return 0x0444 * (2 * c->d - c->a - age) / (c->d - c->a);
	if(age < c->s) return 0x0444;
	if(age < c->r) return 0x0444 * (c->r - age) / (c->r - c->s);
	c->advance = 0;
	return 0x0000;
}

void
nds_apu_start(NdsApu *c, Uint16 adsr, Uint8 pitch, Uint8 detune)
{
	if(pitch < 108 && c->len)
		c->advance = (Uint32)((float)(advances[pitch % 12]) * detunes[detune]) >> (8 - pitch / 12);
	else {
		c->advance = 0;
		return;
	}
	c->a = ADSR_STEP * (adsr >> 12);
	c->d = ADSR_STEP * (adsr >> 8 & 0xf) + c->a;
	c->s = ADSR_STEP * (adsr >> 4 & 0xf) + c->d;
	c->r = ADSR_STEP * (adsr >> 0 & 0xf) + c->s;
	c->age = 0;
	c->i = 0;
	if(c->len <= 0x100) /* single cycle mode */
		c->period = NOTE_PERIOD * 337 / 2 / c->len;
	else /* sample repeat mode */
		c->period = NOTE_PERIOD;
}

Uint8
nds_apu_get_vu(NdsApu *c)
{
	int i;
	Sint32 sum[2] = {0, 0};
	if(!c->advance || !c->period) return 0;
	for(i = 0; i < 2; i++) {
		if(!c->volume[i]) continue;
		sum[i] = 1 + envelope(c, c->age) * c->volume[i] / 0x800;
		if(sum[i] > 0xf) sum[i] = 0xf;
	}
	return (sum[0] << 4) | sum[1];
}
